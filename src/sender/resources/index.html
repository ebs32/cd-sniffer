<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CD Sniffer - Sender</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <style>
      body    { margin: 1vh 0 0 1vh; }
      .spacer { margin: 1vh; }
      #status { color: steelblue }
    </style>
  </head>
  <body>
    <div id="main">
      <div class="spacer">
        Status: <span id="status">Initializing...</span>
      </div>
      <hr>
      <div class="spacer" id="actions"></div>
      <button class="spacer" id="send" disabled>Send</button>
    </div>
    <script type="module">
      let   status     = -1
      const status_xhr = new XMLHttpRequest()
      const addAction  = (actionPayload) => {
        const root   = document.getElementById("actions")
        const action = document.createElement("div")
        const id     = `a_${actionPayload.i}`
        let   node;

        // Create and append the input element
        node = document.createElement("input")

        node.setAttribute("type" , "radio"        )
        node.setAttribute("name" , "action"       )
        node.setAttribute("id"   , id             )
        node.setAttribute("value", actionPayload.i)

        action.appendChild(node)

        // Create and append the label for the input element
        node = document.createElement("label")

        node.setAttribute("for" , id)
        node.innerText = actionPayload.d

        action.appendChild(node)

        // Append the new action to the action container
        root.appendChild(action)
      }
      const setStatus  = (statusPayload) => {
        status = statusPayload.s
        document.getElementById("status").innerText = statusPayload.t

        if (statusPayload.b === 0) {
          document.getElementById("send").removeAttribute("disabled")
        } else {
          document.getElementById("send").setAttribute("disabled", "")
        }
      }
      const getActions = () => {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest()

          xhr.onerror   = reject
          xhr.ontimeout = reject
          xhr.onload    = () => {
            if (xhr.status !== 200) {
              return reject(`Unexpected HTTP Status: ${xhr.status}`)
            }

            try {
              resolve(
                JSON.parse(xhr.response)
              )
            } catch (error) {
              reject(error)
            }
          }

          xhr.open('GET', `/actions?t=${Date.now()}`)
          xhr.send()
        })
      }
      const getStatus  = () => {
        status_xhr.open('GET', `/status?s=${status}&t=${Date.now()}`)
        status_xhr.send()
      }
      const postAction = () => {
        const xhr = new XMLHttpRequest()
        const id  = document.querySelector("#actions input:checked").value

        // Abort the status request to avoid blocking this request
        status_xhr.abort()

        // While the status request will potentially disable the button, this
        // is required to avoid any event between the end of this call and the
        // status request response
        document.getElementById("send").setAttribute("disabled", "")

        xhr.onload = getStatus

        xhr.open('POST', `/action?a=${id}`)
        xhr.send()
      }

      document
        .getElementById  ("send")
        .addEventListener("click", postAction)

      status_xhr.onload = () => {
        if (status_xhr.status !== 200) {
          return console.error(`Unexpected HTTP Status: ${status_xhr.status}`)
        }

        try {
          setStatus(
            JSON.parse(status_xhr.response)
          )

          getStatus()
        } catch (error) {
          console.error('Unexpected Error: ', error)
        }
      }

      getActions()
        .then (actions => {
          for (const action of actions) {
            addAction(action)
          }

          if (actions.length > 0) { // Assumed default action is there...
            document
              .querySelector('#actions input[value="0"]')
              .setAttribute ("checked", "")
          }
        })
        .then (getStatus)
        .catch(console.error)
    </script>
  </body>
</html>
